<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Booster</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'><path fill='%23EA580C' d='M153.6 29.9l16-21.3C173.6 3.2 181.8 0 192 0s18.4 3.2 22.4 8.5l16 21.3C267.1 63.5 314.6 128 320 192c5.4 64-26.4 128-80 160s-128 26.4-160-80c-3.5-22.1-2.9-44.4 .9-66.5l8.5-48.4c4.8-27.3 22-52.1 40-70.1l2.4-2.4C169.5 106.3 162.2 64 153.6 29.9zM192 384c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32z'/></svg>">
    <!-- CSS, Vue, Day.js, Font Awesome ... -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Day.js ä»¥æ–¹ä¾¿è™•ç†æ—¥æœŸ -->
    <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://unpkg.com/dayjs@1/locale/zh-tw.js"></script>
    <!-- å¼•å…¥ Font Awesome åœ–ç¤ºåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ï¼Œä½¿æ•´é«”å¤–è§€æ›´æŸ”å’Œ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* ä½¿ç”¨æŸ”å’Œçš„èƒŒæ™¯è‰² */
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
            color: #ea580c; /* corresponds to orange-600 */
        }
        /* é‡å°å‹•ç•«æ•ˆæœçš„ CSS */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        .slide-fade-enter-active {
          transition: all 0.3s ease-out;
        }
        .slide-fade-leave-active {
          transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
        }
        .slide-fade-enter-from,
        .slide-fade-leave-to {
          transform: translateY(20px);
          opacity: 0;
        }
        .ghost {
            opacity: 0.5;
            background: #f0f9ff;
        }
        /* è‡ªè¨‚ clip-path è®“è‘‰å­è®Šæˆæ˜Ÿæ˜Ÿå½¢ç‹€ */
        .clip-path-polygon {
            clip-path: polygon(
                50% 0%,
                61% 35%,
                98% 35%,
                68% 57%,
                79% 91%,
                50% 70%,
                21% 91%,
                32% 57%,
                2% 35%,
                39% 35%
            );
        }
    </style>
</head>

</head>
<body>

<div id="app" class="flex h-screen bg-gray-100 antialiased">
    <!-- Sidebar å´é‚Šå°è¦½åˆ— -->
    <aside class="w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-8">
        <div class="text-orange-600">
            <i class="fa-solid fa-rocket fa-2x"></i>
        </div>
        <nav class="flex flex-col items-center space-y-8">
            <a href="#" @click.prevent="currentView = 'dashboard'" class="sidebar-icon text-gray-500 p-3 rounded-lg" :class="{ 'bg-orange-100 text-orange-600': currentView === 'dashboard' }" title="å„€è¡¨æ¿">
                <i class="fa-solid fa-tachometer-alt fa-2x"></i>
            </a>
            <a href="#" @click.prevent="currentView = 'goals'" class="sidebar-icon text-gray-500 p-3 rounded-lg" :class="{ 'bg-orange-100 text-orange-600': currentView === 'goals' }" title="ç›®æ¨™è¨­å®š">
                <i class="fa-solid fa-bullseye fa-2x"></i>
            </a>
            <a href="#" @click.prevent="currentView = 'todos'" class="sidebar-icon text-gray-500 p-3 rounded-lg" :class="{ 'bg-orange-100 text-orange-600': currentView === 'todos' }" title="å¾…è¾¦æ¸…å–®">
                <i class="fa-solid fa-list-check fa-2x"></i>
            </a>
            <a href="#" @click.prevent="currentView = 'calendar'" class="sidebar-icon text-gray-500 p-3 rounded-lg" :class="{ 'bg-orange-100 text-orange-600': currentView === 'calendar' }" title="è¡Œäº‹æ›†">
                <i class="fa-solid fa-calendar-days fa-2x"></i>
            </a>
            <!-- æ›´æ–°ç‚º Font Awesome åœ–ç¤º -->
            <a href="#" @click.prevent="currentView = 'pomodoro'" class="sidebar-icon text-gray-500 p-3 rounded-lg" :class="{ 'bg-orange-100 text-orange-600': currentView === 'pomodoro' }" title="ç•ªèŒ„é˜">
                <!-- ä½¿ç”¨ Font Awesome åœ–ç¤º -->
                <i class="fa-solid fa-clock-rotate-left fa-2x"></i>
            </a>
        </nav>
    </aside>

    <!-- Main Content ä¸»è¦å…§å®¹å€åŸŸ -->
    <main class="flex-1 p-6 md:p-8 overflow-y-auto">
        <Transition name="slide-fade" mode="out-in">
        <div :key="currentView">

            <!-- å„€è¡¨æ¿è¦–åœ– -->
            <div v-if="currentView === 'dashboard'">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">å„€è¡¨æ¿</h1>
                <p class="text-gray-500 mb-8">ä¸æƒ³ä¹‹å¾Œå“­è‘—å¾Œæ‚”ï¼Œç¾åœ¨å°±é¦¬ä¸Šè¡Œå‹•ï¼</p>
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
                    <div v-if="mainGoal">
                        <h2 class="text-xl font-semibold text-gray-700 text-center">è·é›¢ç›®æ¨™ï¼š <span class="text-orange-600">{{ mainGoal.title }}</span></h2>
                        <p class="text-gray-500 text-center mb-6">ç›®æ¨™æ—¥æœŸï¼š{{ dayjs(mainGoal.targetDate).format('YYYY-MM-DD') }}</p>
                        <div v-if="countdown" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-gray-100 p-6 rounded-xl">
                                <div class="text-4xl font-bold text-orange-600">{{ countdown.days }}</div>
                                <div class="text-gray-500">å¤©</div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-xl">
                                <div class="text-4xl font-bold text-orange-600">{{ countdown.hours }}</div>
                                <div class="text-gray-500">å°æ™‚</div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-xl">
                                <div class="text-4xl font-bold text-orange-600">{{ countdown.minutes }}</div>
                                <div class="text-gray-500">åˆ†é˜</div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-xl">
                                <div class="text-4xl font-bold text-orange-600">{{ countdown.seconds }}</div>
                                <div class="text-gray-500">ç§’</div>
                            </div>
                        </div>
                         <div v-else class="text-center text-2xl font-bold text-green-500 mt-4">
                            ç›®æ¨™æ—¥æœŸå·²åˆ°æˆ–å·²éï¼
                        </div>
                    </div>
                    <div v-else class="text-center py-12">
                        <i class="fa-solid fa-bullseye text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">å°šæœªè¨­å®šä»»ä½•ç›®æ¨™</h3>
                        <p class="text-gray-400">å‰å¾€ã€Œç›®æ¨™è¨­å®šã€é é¢æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹ç›®æ¨™å§ï¼</p>
                    </div>
                </div>
            </div>

            <!-- ç›®æ¨™è¨­å®šè¦–åœ– -->
            <div v-if="currentView === 'goals'">
                <div class="flex justify-between items-center mb-6">
                    <div>
                      <h1 class="text-3xl font-bold text-gray-800">æˆ‘çš„ç›®æ¨™</h1>
                      <p class="text-gray-500 mt-1">I see, I come, I conquer.</p>
                    </div>
                    <button @click="openGoalModal()" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-orange-700 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> æ–°å¢ç›®æ¨™
                    </button>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="goal in goals" :key="goal.id" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">{{ goal.title }}</h3>
                            <p class="text-gray-600 my-2">{{ goal.description }}</p>
                            <p class="text-sm text-gray-500">ç›®æ¨™æ—¥æœŸ: {{ dayjs(goal.targetDate).format('YYYY-MM-DD') }}</p>
                            <p class="text-sm font-medium" :class="dayjs(goal.targetDate).isAfter(dayjs()) ? 'text-orange-500' : 'text-green-500'">
                                {{ dayjs(goal.targetDate).fromNow() }}
                            </p>
                        </div>
                        <div class="text-right mt-4">
                            <button @click="openGoalModal(goal)" class="text-blue-500 hover:text-blue-700 transition-colors mr-4">
                                <i class="fa-solid fa-pencil"></i> ç·¨è¼¯
                            </button>
                            <button @click="deleteGoal(goal.id)" class="text-red-500 hover:text-red-700 transition-colors">
                                <i class="fa-solid fa-trash"></i> åˆªé™¤
                            </button>
                        </div>
                    </div>
                    <div v-if="!goals.length" class="text-center py-12 text-gray-500 col-span-full">
                        <i class="fa-solid fa-box-open text-4xl text-gray-300 mb-4"></i>
                        <p>é‚„æ²’æœ‰è¨­å®šç›®æ¨™å–”ï¼</p>
                    </div>
                </div>
            </div>

            <!-- å¾…è¾¦æ¸…å–®è¦–åœ– -->
            <div v-if="currentView === 'todos'">
                 <h1 class="text-3xl font-bold text-gray-800 mb-1">å¾…è¾¦æ¸…å–®</h1>
                 <p class="text-gray-500 mb-6">å‹•èµ·ä¾†å°±å°äº†ï¼</p>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <form @submit.prevent="addTodo" class="flex gap-4 mb-4">
                        <input type="text" v-model="newTodo.text" placeholder="æ–°å¢ä¸€å€‹æ–°ä»»å‹™..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition">
                        <button type="submit" class="bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-700 transition-colors">æ–°å¢</button>
                    </form>
                    <ul>
                        <li v-for="todo in todos" 
                            :key="todo.id" 
                            class="flex items-center justify-between p-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 rounded-lg group cursor-move"
                            :class="{ 'ghost': draggingTodo && draggingTodo.id === todo.id }"
                            draggable="true"
                            @dragstart="dragStart(todo)"
                            @dragover.prevent
                            @drop="onDrop(todo)"
                            @dragend="dragEnd">
                            
                            <div class="flex items-center gap-3 flex-grow">
                                <input type="checkbox" v-model="todo.completed" class="h-5 w-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500 flex-shrink-0">
                                
                                <div v-if="!todo.editing" @dblclick="startEdit(todo)" class="w-full py-1">
                                    <span :class="{ 'line-through text-gray-400': todo.completed }" class="text-gray-700">{{ todo.text }}</span>
                                </div>
                                <input v-else 
                                       type="text" 
                                       v-model="todo.text"
                                       @blur="finishEdit(todo)"
                                       @keyup.enter="finishEdit(todo)"
                                       @keyup.esc="cancelEdit(todo)"
                                       class="flex-grow p-1 border border-orange-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none transition w-full"
                                       v-focus>
                            </div>

                            <div class="flex items-center flex-shrink-0">
                                <button v-if="!todo.editing" @click="startEdit(todo)" class="text-gray-400 hover:text-blue-500 transition-colors px-2 opacity-0 group-hover:opacity-100">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button @click="deleteTodo(todo.id)" class="text-gray-400 hover:text-red-500 transition-colors px-2 opacity-0 group-hover:opacity-100">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </li>
                    </ul>
                     <div v-if="!todos.length" class="text-center py-12 text-gray-500">
                        <i class="fa-solid fa-check-double text-4xl text-gray-300 mb-4"></i>
                        <p>å¤ªæ£’äº†ï¼Œç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …ï¼</p>
                    </div>
                </div>
            </div>

            <!-- è¡Œäº‹æ›†è¦–åœ– -->
            <div v-if="currentView === 'calendar'">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- æœˆæ›† -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 lg:w-2/3">
                        <div class="flex justify-between items-center mb-4">
                            <button @click="prevMonth" class="p-2 rounded-full hover:bg-gray-100"><i class="fa-solid fa-chevron-left"></i></button>
                            <h2 class="text-xl font-bold text-gray-800">{{ currentMonth.format('YYYY å¹´ M æœˆ') }}</h2>
                            <button @click="nextMonth" class="p-2 rounded-full hover:bg-gray-100"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-500 text-sm mb-2">
                            <div v-for="day in ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']" :key="day">{{ day }}</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            <div v-for="day in calendarDays" :key="day.date.toString()" 
                                 @click="selectDate(day.date)"
                                 class="py-1 px-2 rounded-lg cursor-pointer transition-colors flex flex-col items-start justify-start h-28 border border-transparent hover:border-orange-200"
                                 :class="{
                                     'text-gray-400': !day.isCurrentMonth,
                                     'bg-orange-100': day.isCurrentMonth && day.date.isSame(dayjs(), 'day') && !day.date.isSame(selectedDate, 'day'),
                                     'bg-orange-600 text-white font-bold': day.date.isSame(selectedDate, 'day'),
                                     'bg-white': day.isCurrentMonth && !day.date.isSame(dayjs(), 'day') && !day.date.isSame(selectedDate, 'day')
                                 }">
                                <span class="font-semibold" :class="{'text-orange-600': day.date.isSame(dayjs(), 'day') && !day.date.isSame(selectedDate, 'day')}">{{ day.date.format('D') }}</span>
                                <div class="w-full mt-1 overflow-hidden text-xs space-y-1">
                                    <div v-for="event in day.events.slice(0, 2)" :key="event.id" class="p-1 rounded truncate" :class="day.date.isSame(selectedDate, 'day') ? 'bg-orange-500 text-white' : 'bg-green-100 text-green-800'">
                                        {{ event.title }}
                                    </div>
                                    <div v-if="day.events.length > 2" class="text-gray-500">
                                        + {{ day.events.length - 2 }} å€‹è¡Œç¨‹
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ç•¶æ—¥è¡Œç¨‹ -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 lg:w-1/3">
                        <h3 class="text-xl font-bold text-gray-800 mb-1">{{ selectedDate.format('MMMM D, YYYY') }}</h3>
                        <p class="text-gray-500 mb-4">{{ selectedDate.format('dddd') }}</p>
                        <button @click="openEventModal()" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition-colors flex items-center justify-center gap-2 mb-4">
                             <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                        </button>
                        <div class="space-y-3">
                           <div v-for="event in eventsOnSelectedDate" :key="event.id" class="p-3 bg-orange-50 rounded-lg flex justify-between items-start">
                               <div>
                                   <p class="font-semibold text-orange-800">{{ event.title }}</p>
                                   <p class="text-sm text-orange-600">{{ event.startTime }} - {{ event.endTime }}</p>
                               </div>
                               <div class="flex items-center">
                                   <button @click="openEventModal(event)" class="text-blue-500 hover:text-blue-700 text-sm pt-1 mr-3"><i class="fa-solid fa-pencil"></i></button>
                                   <button @click="deleteEvent(event.id)" class="text-orange-400 hover:text-red-500 text-sm pt-1"><i class="fa-solid fa-trash"></i></button>
                               </div>
                           </div>
                           <div v-if="eventsOnSelectedDate.length === 0" class="text-center text-gray-500 pt-8">
                                <i class="fa-solid fa-calendar-check text-3xl text-gray-300 mb-3"></i>
                               <p>é€™å¤©æ²’æœ‰å®‰æ’è¡Œç¨‹ã€‚</p>
                           </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç•ªèŒ„é˜è¦–åœ– -->
            <div v-if="currentView === 'pomodoro'">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ç•ªèŒ„é˜</h1>
                <p class="text-gray-500 mb-8 text-left">è¨­å®šä¸€æ®µæ™‚é–“ï¼Œä¿æŒé«˜åº¦å°ˆæ³¨ï¼</p>
                
                <!-- ç•ªèŒ„å½¢ç‹€å®¹å™¨ -->
                <div class="max-w-md mx-auto flex flex-col items-center pt-8">
                    <!-- ç•ªèŒ„ä¸»é«” -->
                    <div class="relative w-80 h-80 md:w-96 md:h-96 bg-red-600 rounded-full flex flex-col items-center justify-center shadow-2xl">
                        <!-- ğŸŒ¿ Tomato leaves (æ˜Ÿæ˜Ÿè‘‰å­) -->
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-green-600 rotate-45 clip-path-polygon"></div>

                        <!-- æ™‚é–“é¡¯ç¤º -->
                        <div class="text-7xl md:text-8xl font-bold text-white mb-6">
                            {{ pomodoroDisplay }}
                        </div>
                        
                        <!-- æ™‚é–“è¨­å®š -->
                        <div class="flex items-center gap-2 mb-6">
                             <label class="text-red-100 font-semibold text-sm">åˆ†é˜ï¼š</label>
                            <input type="number" 
                                   v-model.number="pomodoro.customMinutes" 
                                   min="1" 
                                   class="w-20 p-2 border border-white/50 bg-white/20 text-white rounded-lg focus:ring-2 focus:ring-white focus:outline-none"
                                   :disabled="pomodoro.isRunning">
                        </div>

                        <!-- æ§åˆ¶æŒ‰éˆ• -->
                        <div class="flex gap-4">
                            <button @click="startPausePomodoro" 
                                    class="w-28 text-center font-bold py-3 px-4 rounded-lg shadow-md transition-colors bg-white hover:bg-red-100"
                                    :class="pomodoro.isRunning ? 'text-yellow-600' : 'text-green-600'">
                                <i class="fa-solid" :class="pomodoro.isRunning ? 'fa-pause' : 'fa-play'"></i>
                                {{ pomodoro.isRunning ? 'æš«åœ' : 'é–‹å§‹' }}
                            </button>
                            <button @click="resetPomodoro" 
                                    class="w-28 text-center border border-white/50 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-white/20 transition-colors">
                                <i class="fa-solid fa-rotate-right"></i>
                                é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        </Transition>
    </main>

    <!-- Modal å½ˆå‡ºè¦–çª— -->
    <Transition name="fade">
        <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md m-4">
                <!-- æ–°å¢/ç·¨è¼¯ç›®æ¨™ Modal -->
                <div v-if="showModal === 'goalForm'">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">{{ goalForm.id ? 'ç·¨è¼¯ç›®æ¨™' : 'æ–°å¢ä¸€å€‹æ–°ç›®æ¨™' }}</h2>
                    <form @submit.prevent="saveGoal">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">ç›®æ¨™åç¨±</label>
                            <input type="text" v-model="goalForm.title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">ç›®æ¨™æè¿°</label>
                            <textarea v-model="goalForm.description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">ç›®æ¨™æ—¥æœŸ</label>
                            <input type="date" v-model="goalForm.targetDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                        </div>
                        <div class="flex justify-end gap-4">
                            <button type="button" @click="showModal = null" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                            <button type="submit" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700">å„²å­˜</button>
                        </div>
                    </form>
                </div>

                <!-- ç•ªèŒ„é˜æé†’ Modal -->
                <div v-if="showModal === 'pomodoroAlert'">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">æ™‚é–“åˆ°ï¼</h2>
                    <p class="text-gray-600 mb-6">å°ˆæ³¨æ™‚é–“çµæŸï¼Œèµ·ä¾†ä¼‘æ¯ä¸€ä¸‹å§ï¼</p>
                    <div class="flex justify-end">
                        <button @click="closePomodoroAlert" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700">å¥½çš„</button>
                    </div>
                </div>

            </div>
        </div>
    </Transition>
</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted, onUnmounted } = Vue;

    const app = createApp({
        setup() {
            // è¨­å®š Day.js
            dayjs.extend(window.dayjs_plugin_relativeTime);
            dayjs.locale('zh-tw');

            // --- éŸ¿æ‡‰å¼ç‹€æ…‹ ---
            const currentView = ref('dashboard');
            const goals = ref(JSON.parse(localStorage.getItem('goals') || '[]'));
            const todos = ref(JSON.parse(localStorage.getItem('todos') || '[]').map(todo => ({...todo, editing: false})));
            const events = ref(JSON.parse(localStorage.getItem('events') || '[]'));
            
            const showModal = ref(null); // 'goalForm', 'eventForm', null

            const goalForm = reactive({ id: null, title: '', description: '', targetDate: '' });
            const eventForm = reactive({ id: null, date: '', title: '', startTime: '', endTime: '' });
            const newTodo = reactive({ text: '' });
            let originalTodoText = '';
            const draggingTodo = ref(null);
 
            const countdown = ref(null);
            let countdownInterval = null;

            // ç•ªèŒ„é˜ç‹€æ…‹
            const pomodoro = reactive({
                defaultMinutes: 25,
                minutes: 25,
                seconds: 0,
                isRunning: false,
                timerId: null,
                customMinutes: 25
            });

            const currentMonth = ref(dayjs());
            const selectedDate = ref(dayjs());

            // --- è¨ˆç®—å±¬æ€§ ---
            const mainGoal = computed(() => {
                const futureGoals = goals.value
                    .filter(g => dayjs(g.targetDate).isAfter(dayjs()))
                    .sort((a, b) => dayjs(a.targetDate).diff(dayjs(b.targetDate)));
                return futureGoals.length > 0 ? futureGoals[0] : (goals.value.length > 0 ? goals.value[0] : null);
            });

            const calendarDays = computed(() => {
                const startOfMonth = currentMonth.value.startOf('month');
                const endOfMonth = currentMonth.value.endOf('month');
                const startDate = startOfMonth.startOf('week');
                const endDate = endOfMonth.endOf('week');
                
                let days = [];
                let day = startDate;

                while (day.isBefore(endDate) || day.isSame(endDate, 'day')) {
                    days.push({
                        date: day,
                        isCurrentMonth: day.isSame(currentMonth.value, 'month'),
                        events: events.value
                            .filter(e => dayjs(e.date).isSame(day, 'day'))
                            .sort((a,b) => a.startTime.localeCompare(b.startTime))
                    });
                    day = day.add(1, 'day');
                }
                return days;
            });
            
            const eventsOnSelectedDate = computed(() => {
                return events.value
                    .filter(event => dayjs(event.date).isSame(selectedDate.value, 'day'))
                    .sort((a,b) => a.startTime.localeCompare(b.startTime));
            });

            // ç•ªèŒ„é˜æ™‚é–“é¡¯ç¤º
            const pomodoroDisplay = computed(() => {
                const minutes = String(pomodoro.minutes).padStart(2, '0');
                const seconds = String(pomodoro.seconds).padStart(2, '0');
                return `${minutes}:${seconds}`;
            });

            // --- æ–¹æ³• ---

            // ç›®æ¨™ç®¡ç†
            const openGoalModal = (goal = null) => {
                if (goal) {
                    Object.assign(goalForm, goal);
                } else {
                    goalForm.id = null;
                    goalForm.title = '';
                    goalForm.description = '';
                    goalForm.targetDate = '';
                }
                showModal.value = 'goalForm';
            };

            const saveGoal = () => {
                if (!goalForm.title || !goalForm.targetDate) return;
                if (goalForm.id) {
                    const index = goals.value.findIndex(g => g.id === goalForm.id);
                    if (index !== -1) {
                        goals.value[index] = { ...goalForm };
                    }
                } else {
                    goals.value.push({
                        ...goalForm,
                        id: Date.now()
                    });
                }
                showModal.value = null;
            };

            const deleteGoal = (id) => {
                goals.value = goals.value.filter(g => g.id !== id);
            };

            // å¾…è¾¦äº‹é …ç®¡ç†
            const addTodo = () => {
                if (!newTodo.text.trim()) return;
                todos.value.unshift({
                    id: Date.now(),
                    text: newTodo.text,
                    completed: false,
                    editing: false
                });
                newTodo.text = '';
            };
            const deleteTodo = (id) => {
                todos.value = todos.value.filter(t => t.id !== id);
            };

            const startEdit = (todo) => {
                originalTodoText = todo.text;
                todos.value.forEach(t => t.editing = false);
                todo.editing = true;
            };

            const finishEdit = (todo) => {
                if (!todo.text.trim()) {
                    todo.text = originalTodoText;
                }
                todo.editing = false;
                originalTodoText = '';
            };

            const cancelEdit = (todo) => {
                todo.text = originalTodoText;
                todo.editing = false;
                originalTodoText = '';
            };

            const dragStart = (todo) => {
                draggingTodo.value = todo;
            };

            const onDrop = (targetTodo) => {
                if (!draggingTodo.value || draggingTodo.value.id === targetTodo.id) {
                    draggingTodo.value = null;
                    return;
                };
                
                const fromIndex = todos.value.findIndex(t => t.id === draggingTodo.value.id);
                const toIndex = todos.value.findIndex(t => t.id === targetTodo.id);

                if (fromIndex !== -1 && toIndex !== -1) {
                    const item = todos.value.splice(fromIndex, 1)[0];
                    todos.value.splice(toIndex, 0, item);
                }
            };

            const dragEnd = () => {
                draggingTodo.value = null;
            };


            // è¡Œç¨‹ç®¡ç†
            const openEventModal = (event = null) => {
                if (event) {
                    Object.assign(eventForm, event);
                } else {
                    eventForm.id = null;
                    eventForm.title = '';
                    eventForm.startTime = '';
                    eventForm.endTime = '';
                    eventForm.date = selectedDate.value.format('YYYY-MM-DD');
                }
                showModal.value = 'eventForm';
            };

            const saveEvent = () => {
                if (!eventForm.title || !eventForm.startTime || !eventForm.endTime) return;
                if (eventForm.id) {
                    const index = events.value.findIndex(e => e.id === eventForm.id);
                    if (index !== -1) {
                        events.value[index] = { ...eventForm };
                    }
                } else {
                    events.value.push({ ...eventForm, id: Date.now() });
                }
                showModal.value = null;
            };
            
            const deleteEvent = (id) => {
                events.value = events.value.filter(e => e.id !== id);
            };

            // è¡Œäº‹æ›†å°è¦½
            const prevMonth = () => currentMonth.value = currentMonth.value.subtract(1, 'month');
            const nextMonth = () => currentMonth.value = currentMonth.value.add(1, 'month');
            const selectDate = (date) => selectedDate.value = date;

            // --- ç•ªèŒ„é˜æ–¹æ³• ---
            const tickPomodoro = () => {
                if (pomodoro.seconds > 0) {
                    pomodoro.seconds--;
                } else if (pomodoro.minutes > 0) {
                    pomodoro.minutes--;
                    pomodoro.seconds = 59;
                } else {
                    // æ™‚é–“åˆ°
                    clearInterval(pomodoro.timerId);
                    pomodoro.isRunning = false;
                    pomodoro.timerId = null;
                    showModal.value = 'pomodoroAlert';
                }
            };

            const startPausePomodoro = () => {
                if (pomodoro.isRunning) {
                    // æš«åœ
                    clearInterval(pomodoro.timerId);
                    pomodoro.isRunning = false;
                    pomodoro.timerId = null;
                } else {
                    // é–‹å§‹
                    pomodoro.isRunning = true;
                    // å¦‚æœæ˜¯å‰›é‡ç½®çš„ç‹€æ…‹ï¼Œå¾è¨­å®šçš„åˆ†é˜æ•¸é–‹å§‹
                    if (pomodoro.minutes === 0 && pomodoro.seconds === 0) {
                         pomodoro.minutes = pomodoro.customMinutes || pomodoro.defaultMinutes;
                         pomodoro.seconds = 0;
                    }
                    pomodoro.timerId = setInterval(tickPomodoro, 1000);
                }
            };

            const resetPomodoro = () => {
                if (pomodoro.timerId) {
                    clearInterval(pomodoro.timerId);
                }
                pomodoro.isRunning = false;
                pomodoro.timerId = null;
                pomodoro.minutes = pomodoro.customMinutes || pomodoro.defaultMinutes;
                pomodoro.seconds = 0;
            };

            const closePomodoroAlert = () => {
                showModal.value = null;
                resetPomodoro(); // é—œé–‰æç¤ºå¾Œè‡ªå‹•é‡ç½®
            };

            // --- å€’æ•¸è¨ˆæ™‚å™¨é‚è¼¯ ---
            const startCountdown = () => {
                if(countdownInterval) clearInterval(countdownInterval);

                countdownInterval = setInterval(() => {
                    if (!mainGoal.value) {
                        countdown.value = null;
                        return;
                    }
                    const now = dayjs();
                    const target = dayjs(mainGoal.value.targetDate);
                    if(now.isAfter(target)){
                        countdown.value = null;
                        clearInterval(countdownInterval);
                        return;
                    }

                    const diff = target.diff(now);
                    const duration = {
                        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                        hours: Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
                        minutes: Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)),
                        seconds: Math.floor((diff % (1000 * 60)) / 1000)
                    };
                    countdown.value = duration;
                }, 1000);
            };

            // --- è³‡æ–™æŒä¹…åŒ– ---
            watch(goals, (newGoals) => {
                localStorage.setItem('goals', JSON.stringify(newGoals));
                startCountdown();
            }, { deep: true });

            watch(todos, (newTodos) => {
                localStorage.setItem('todos', JSON.stringify(newTodos));
            }, { deep: true });
            
            watch(events, (newEvents) => {
                localStorage.setItem('events', JSON.stringify(newEvents));
            }, { deep: true });

            // --- ç”Ÿå‘½é€±æœŸé‰¤å­ ---
            onMounted(() => {
                startCountdown();
            });
            onUnmounted(() => {
                clearInterval(countdownInterval);
                if (pomodoro.timerId) { // é›¢é–‹é é¢æ™‚æ¸…é™¤ç•ªèŒ„é˜
                    clearInterval(pomodoro.timerId);
                }
            });

            return {
                currentView,
                goals,
                todos,
                events,
                showModal,
                goalForm,
                eventForm,
                newTodo,
                mainGoal,
                countdown,
                draggingTodo,
                openGoalModal,
                saveGoal,
                deleteGoal,
                addTodo,
                deleteTodo,
                startEdit,
                finishEdit,
                cancelEdit,
                dragStart,
                onDrop,
                dragEnd,
                dayjs,
                currentMonth,
                selectedDate,
                calendarDays,
                eventsOnSelectedDate,
                prevMonth,
                nextMonth,
                selectDate,
                openEventModal,
                saveEvent,
                deleteEvent,
                // ç•ªèŒ„é˜
                pomodoro,
                pomodoroDisplay,
                startPausePomodoro,
                resetPomodoro,
                closePomodoroAlert
            };
        }
    });

    // è¨»å†Šä¸€å€‹è‡ªå®šç¾©æŒ‡ä»¤ v-focusï¼Œç”¨æ–¼è‡ªå‹•èšç„¦
    app.directive('focus', {
      mounted: (el) => el.focus()
    });
    
    app.mount('#app');
</script>

</body>
</html>





